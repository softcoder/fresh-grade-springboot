<html>
<link rel="stylesheet" type="text/css" href="css/main.css">
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.0/jquery.min.js"></script>

<body>
    <div class="header-container">
        <form id="add_student_form" action="/v1/student-manager/create_fullname" method="post" enctype="multipart/form-data">
        <table class="table-center">
            <tr>
                <td>
                    <table class="table-center">
                    <tr>
                        <td>
                            <a href="/index.html" class="head-blue-left no-decor-link">Cancel</a>
                        </td>
                        <td>
                            <h1 class="head-black">Add Student</h1>
                        </td>
                        <td>
                            <a href="#" onclick="if(trigger_submit_form()) { return true; } else { return false; }" class="head-blue-right no-decor-link">Save</a>
                        </td>
                    </tr>
                    </table>
                </td>        
            </tr>
            <tr>
                <td>
                    <div class="action-container-left">
                        <a href="#" onclick="getRandomUser(); return false;" class="head-blue no-decor-link"><span class='left-arrow-blue'>+</span>Get Random Student</a>
                    </div>
                </td>        
            </tr>
            <tr>
                <td>
                    <div class="action-container">
                        <image class="photo-container" id="photoFilePreview" name="photoFilePreview" src="images/photo-default.png">
                        <a href="#" onclick="$('#photoFile').trigger('click');" class="head-blue no-decor-link"><img class="info-icon" title="Add a student." src="/images/add-icon.png">Add Profile Photo</a>
                        <input type="file" name="photoFile" id="photoFile" accept="image/png image/jpg" class="hide-item">
                    </div>
                </td>        
            </tr>
            <tr>
                <td>
                    <div class="input-container-left">
                        <label class="label" for="full_name">Name</label>                        
                        <input class="input-text-left required" type="text" name="full_name" 
                                id="full_name" placeholder="enter your first and last name" required>
                        <input type="submit" name="full_name_submit" id="full_name_submit" class="hide-item">
                    </div>
                </td>        
            </tr>

        </table>
    </form>
    </div>

<script>
function readURL(input) {
    if (input.files && input.files[0]) {
        var reader = new FileReader();
        reader.onload = function (e) {
            $('#photoFilePreview').attr('src', e.target.result);
        }
        reader.readAsDataURL(input.files[0]);
    }
}

$("#photoFile").change(function(){
    readURL(this);
});

function getBase64Image(img) {
    
    var canvas = document.createElement("canvas");
    canvas.width = img.width;
    canvas.height = img.height;
    var ctx = canvas.getContext("2d");
    ctx.drawImage(img, 10, 10);
    var dataURL = canvas.toDataURL("image/jpg");
    // Can't copy the Image to upload to the rest API when pulled down from another domain.
    var dataURL = canvas.toDataURL();
    return dataURL.replace(/^data:image\/(png|jpg);base64,/, "");
}


function trigger_submit_form() {
    //debugger;
    var encodedName = encodeURIComponent($("#full_name").val());
    if(encodedName != null && encodedName.trim() != '') {
        var formData = null;
        if($('input[type=file]')[0].files.length > 0) {
            formData = new FormData();
            formData.append('photoFile', $('input[type=file]')[0].files[0]); 
        }
/*        
        // Can't copy the Image to upload to the rest API when pulled down from another domain.
        else if($('#photoFilePreview').src != '') {
            var base64 = getBase64Image(document.getElementById('photoFilePreview'));
            if(base64 != null) {
                formData = new FormData();
                formData.append('photoFile', base64); 
            }
        }
*/
        $.ajax({
            url: "/v1/student-manager/create_fullname?full_name="+encodedName,
            type: "POST",
            encoding:"UTF-8",
            data: formData,
            cache: false,
            contentType: false,
            processData: false,
            success: function ( data ) {
                window.location.href = "/view_student_detail.html?student_id="+data.id;
            },
            error: function (xhr, ajaxOptions, thrownError) {
            	//debugger;
                alert('Error Status: '+ xhr.status + ' message: ' + xhr.responseText);
            }
        });
    }
    else {
        $('#full_name_submit').trigger('click');
    }
}

function getRandomUser() {
    $.ajax({
      url: 'https://randomuser.me/api/?inc=name,picture',
      contentType: "application/json; charset=utf-8",
      dataType: 'json',
      success: function(data) {
        //debugger;        
        console.log(data);

        var encodedName = data.results[0].name.first + ' ' + data.results[0].name.last;
        $("#full_name").val(encodedName);
        $('#photoFilePreview').attr('src', data.results[0].picture.medium).fadeIn();
      }
    });
}
</script>
</body>
</html>
